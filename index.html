<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Anonymous Feedback ‚úçÔ∏è</title>

  <style>
    /* ====== General Page Styling ====== */
    body {
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: #e0e0e0;
      line-height: 1.6;
      padding: 20px;
      margin: 0;
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
      background-color: #1e1e1e;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
    }

    h1, h2 {
      text-align: center;
      color: #4da3ff;
    }
    
    h1 {
      margin-top: 0;
    }

    hr {
      border: 1px solid #333;
      margin-top: 25px;
      margin-bottom: 15px;
    }

    p {
      text-align: center;
      margin-top: 0;
      color: #bbb;
    }
    
    .note {
      text-align: center;
      color: #bbb;
      font-style: italic;
      margin-top: 20px;
      font-size: 14px;
    }
    
    .warning-text {
      color: #ffcc00;
      font-weight: bold;
      font-size: 13px;
      text-align: center;
      margin-top: 10px;
    }

    /* ====== Login/Register Screen ====== */
    #welcomeScreen {
      background-color: #1e1e1e;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
      text-align: center;
    }
    
    #welcomeScreen h1 {
      margin-top: 0;
    }

    .login-form input {
      width: 90%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #444;
      border-radius: 4px;
      background-color: #222;
      color: #e0e0e0;
      font-size: 16px;
    }

    .login-form button {
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 12px 20px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin: 5px;
    }

    .login-form button:hover {
      background-color: #0056b3;
    }
    
    #authError {
      color: #ff4d4d;
      margin-top: 15px;
      font-weight: bold;
    }

    /* ====== Header / Auth Status ====== */
    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 10px;
      background-color: #2a2a2a;
      border-radius: 6px;
      margin-bottom: 20px;
    }

    #authStatus {
      font-size: 14px;
      color: #aaa;
    }

    #logoutButton {
      background: #c9302c;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: background-color 0.3s;
    }
    
    #logoutButton:hover {
      background: #a92a26;
    }

    /* ====== Notification System ====== */
    .notifications {
      position: relative;
    }

    #notificationBell {
      font-size: 24px;
      cursor: pointer;
      background: none;
      border: none;
      color: #aaa;
      position: relative;
    }
    
    #notificationBell:hover {
      color: #fff;
    }

    #notificationDot {
      position: absolute;
      top: 0;
      right: 0;
      width: 10px;
      height: 10px;
      background-color: #ff4d4d;
      border-radius: 50%;
      display: none; /* Hidden by default */
    }

    #notificationPanel {
      position: absolute;
      top: 40px;
      right: 0;
      width: 300px;
      max-height: 400px;
      overflow-y: auto;
      background-color: #2c2c2c;
      border: 1px solid #444;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      z-index: 100;
      display: none; /* Hidden by default */
    }
    
    .notification-item {
      padding: 12px;
      border-bottom: 1px solid #444;
      color: #ddd;
      font-size: 14px;
    }
    
    .notification-item:last-child {
      border-bottom: none;
    }
    
    .notification-item.unread {
      background-color: #3a3a3a;
    }
    
    .notification-item-empty {
      padding: 20px;
      text-align: center;
      color: #888;
    }

    /* ====== Tabs Styling ====== */
    .tabs-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #333;
    }

    .tab-btn {
      padding: 10px 15px;
      cursor: pointer;
      background-color: transparent;
      border: none;
      color: #aaa;
      font-size: 16px;
      font-weight: bold;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }

    .tab-btn:hover {
      color: #e0e0e0;
    }

    .tab-btn.active {
      color: #4da3ff;
      border-bottom-color: #4da3ff;
    }

    /* ====== Comment Form ====== */
    #commentForm {
      margin-bottom: 20px;
    }
    
    #commentForm textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      border: 1px solid #444;
      border-radius: 4px;
      resize: vertical;
      min-height: 80px;
      margin-bottom: 10px;
      background-color: #222;
      color: #e0e0e0;
    }
    
    #commentForm textarea:disabled {
      background-color: #2a2a2a;
      cursor: not-allowed;
    }

    #commentForm button {
      width: 100%;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    #commentForm button:hover {
      background-color: #0056b3;
    }
    
    #commentForm button:disabled {
      background-color: #004a9a;
      cursor: not-allowed;
    }
    
    /* ====== Sort Controls ====== */
    .sort-controls {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
    }
    
    .sort-controls label {
      font-size: 14px;
      color: #aaa;
    }
    
    #sortControl {
      background-color: #2a2a2a;
      color: #e0e0e0;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 5px 8px;
      font-size: 14px;
    }

    /* ====== Comments & Replies ====== */
    .comment-box,
    .reply-box {
      position: relative;
      border: 2px solid #4da3ff;
      padding: 10px 12px 12px 12px;
      border-radius: 6px;
      margin-top: 12px;
      background-color: #181818;
    }

    .reply-box {
      margin-left: 40px;
      border-color: #555;
    }
    
    .author-line {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    
    .comment-author {
      font-weight: bold;
      color: #aaa;
      font-size: 13px;
      display: inline; /* Changed */
    }
    
    .comment-timestamp {
      font-size: 12px;
      color: #888;
      margin-left: 8px;
      display: inline;
    }
    
    .comment-author.admin {
      color: #FFD700; /* Golden color */
      font-weight: bold;
      text-shadow: 0 0 4px rgba(255, 215, 0, 0.5);
    }
    
    .comment-author.tuntun {
      color: #ff4d4d; /* Red color */
      font-weight: bold;
      text-shadow: 0 0 4px rgba(255, 77, 77, 0.5);
    }

    .comment-box p,
    .reply-box p {
      margin: 0 0 8px 0;
      font-size: 15px;
      color: #f5f5f5;
      white-space: pre-wrap;
      text-align: left; /* <-- Added this line */
    }

    /* ====== Reaction and Reply Controls ====== */
    .controls {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 15px;
      margin-top: 10px;
      position: relative;
      min-height: 30px; /* Ensure space for reactions */
    }

    .reaction-options {
      position: absolute;
      right: 0;
      bottom: 0;
      display: flex;
      gap: 6px;
    }

    .reaction {
      cursor: pointer;
      font-size: 18px;
      transition: transform 0.2s;
      user-select: none;
      padding: 2px 4px;
      border-radius: 4px;
    }
    
    .reaction:hover {
      transform: scale(1.25);
      background-color: #333;
    }

    .reply-btn,
    .edit-btn,
    .delete-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      color: #4da3ff;
      transition: color 0.3s;
      padding: 0;
    }
    
    .edit-btn, .delete-btn {
      font-size: 18px;
      color: #aaa;
    }

    .reply-btn:hover,
    .edit-btn:hover,
    .delete-btn:hover {
      color: #1e90ff;
    }
    
    .delete-btn:hover {
      color: #ff4d4d;
    }
    
    .delete-btn.confirm {
      color: #ff4d4d;
      font-weight: bold;
    }

    .replies {
      margin-top: 10px;
      margin-left: 20px;
    }

    .reply-form,
    .edit-form {
      margin-top: 10px;
      background-color: #202020;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 10px;
    }

    .reply-form textarea,
    .edit-form textarea {
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #555;
      border-radius: 4px;
      resize: vertical;
      min-height: 60px;
      padding: 6px;
      background-color: #2a2a2a;
      color: #e0e0e0;
    }

    .reply-form button,
    .edit-form button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 6px 12px;
      margin-top: 6px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s ease;
      margin-right: 5px;
    }
    
    .edit-form button.cancel-btn {
      background-color: #555;
    }

    .reply-form button:hover,
    .edit-form button:hover {
      background-color: #0056b3;
    }
    
    .edit-form button.cancel-btn:hover {
      background-color: #444;
    }

    #commentsContainer .empty-message {
      text-align: center;
      color: #bbb;
      font-style: italic;
      margin-top: 20px;
    }
    
    /* ====== Modal ("What's New") Styling ====== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: #2a2a2a;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
      width: 90%;
      max-width: 500px;
      text-align: left;
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }
    
    .modal-overlay.show .modal-content {
      transform: scale(1);
    }

    .modal-content h2 {
      text-align: center;
      color: #4da3ff;
      margin-top: 0;
    }
    
    .modal-content ul {
      list-style-type: none;
      padding-left: 0;
    }
    
    .modal-content li {
      margin-bottom: 15px;
      font-size: 16px;
      color: #ddd;
    }
    
    .modal-content li strong {
      color: #4da3ff;
      display: block;
      font-size: 17px;
    }
    
    .modal-content button {
      display: block;
      width: 100%;
      margin-top: 20px;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 12px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    
    .modal-content button:hover {
      background-color: #0056b3;
    }
  </style>
</head>

<body>
  <!-- "What's New" Modal -->
  <div id="whatsNewModal" class="modal-overlay">
    <div class="modal-content">
      <h2>üéâ What's New? üéâ</h2>
      <ul>
        <li>
          <strong>User Accounts:</strong>
          You can now create a secure, anonymous account with a username and password to post.
        </li>
        <li>
          <strong>Edit & Delete:</strong>
          You have full control! You can now edit or delete any of your own comments and replies.
        </li>
        <li>
          <strong>Notifications:</strong>
          Click the üîî bell icon to see when someone reacts or replies to your posts.
        </li>
      </ul>
      <button id="closeModalButton">Got it!</button>
    </div>
  </div>

  <!-- Login/Register Screen -->
  <div id="welcomeScreen">
    <h1>Welcome to ISRT Feedback</h1>
    <p>Please log in or register to continue.</p>
    <div class="warning-text" style="font-size: 16px; margin-bottom: 20px;">
      Warning: For anonymity, do not use a personal or identifying username.
      Do not share any personal details.
    </div>
    
    <form class="login-form" id="loginForm">
      <input type="text" id="usernameInput" placeholder="Username" required>
      <input type="password" id="passwordInput" placeholder="Password" required>
      <div id="authError"></div>
      <button type="submit" id="loginButton">Login</button>
      <button type="submit" id="registerButton">Register</button>
    </form>
  </div>

  <!-- Main App Container (Hidden by default) -->
  <div class="container" id="mainApp" style="display: none;">
    <div class="header-bar">
      <div id="authStatus">Loading...</div>
      <div class="notifications">
        <button id="notificationBell">
          üîî
          <span id="notificationDot"></span>
        </button>
        <div id="notificationPanel">
          <div id="notificationList">
            <div class="notification-item-empty">No notifications yet.</div>
          </div>
        </div>
      </div>
      <button id="logoutButton">Logout</button>
    </div>
    
    <h1>Anonymous Feedback ‚úçÔ∏è</h1>
    <p>Share your thoughts. All comments are anonymous.</p>

    <p style="font-size: 16px; color: #ccc; margin-top: 20px; margin-bottom: 10px;">Share your thoughts about</p>
    <div id="tabsContainer" class="tabs-container">
      <button class="tab-btn active" data-category="general">General</button>
      <button class="tab-btn" data-category="seniors">Seniors</button>
      <button class="tab-btn" data-category="juniors">Juniors</button>
      <button class="tab-btn" data-category="faculty">Faculty</button>
      <button class="tab-btn" data-category="all">All Comments</button>
    </div>

    <form id="commentForm">
      <textarea id="commentText" placeholder="Your comment here..." required disabled></textarea>
      <div class="warning-text">
        Warning: Do not share any personal details.
      </div>
      <button type="submit" id="commentSubmitButton" disabled>Submit Comment</button>
    </form>

    <hr />
    <p class="note">Previous Comments are stored in all comments section.</p>
    <h2>Previous Comments</h2>
    
    <!-- NEW: Sort Controls -->
    <div class="sort-controls">
      <label for="sortControl">Sort by: </label>
      <select id="sortControl">
        <option value="newest">Newest</option>
        <option value="mostReacted">Most Reacted</option>
      </select>
    </div>
    
    <div id="loading" style="display: none; text-align: center; margin: 20px 0;">Loading comments...</div>
    <div id="commentsContainer"><p class="empty-message">No comments yet. Be the first!</p></div>
  </div>

  <script type="module">
    // =============================
    // Import Firebase SDKs
    // =============================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getDatabase,
      ref,
      push,
      onValue,
      update,
      set,
      serverTimestamp,
      remove,
      off,
      query,
      orderByChild,
      equalTo,
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    // =============================
    // Firebase Configuration
    // =============================
    const firebaseConfig = {
      apiKey: "AIzaSyBi0DtNzX0niHbV4LtId7PaxLoD8Pphy6U",
      authDomain: "comment-on-isrt-8a634.firebaseapp.com",
      databaseURL: "https://comment-on-isrt-8a634-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "comment-on-isrt-8a634",
      storageBucket: "comment-on-isrt-8a634.appspot.com",
      messagingSenderId: "173989173917",
      appId: "1:173989173917:web:613693b2c98c4c121e9274",
    };

    // =============================
    // Initialize Firebase
    // =============================
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // =============================
    // Global State
    // =============================
    let currentCategory = 'general';
    let currentSort = 'newest'; // NEW: Sort state
    let currentCommentsRef = null;
    let currentUserId = null;
    let currentUsername = null;
    let notificationListener = null;
    const reactions = ["üëç", "üòÇ", "üòç", "üò¢", "üòÆ", "üò°", "üòÄ"];
    const WHATS_NEW_KEY = 'whatsNewModalSeen_v1';

    // =============================
    // DOM Elements
    // =============================
    const commentForm = document.getElementById("commentForm");
    const commentText = document.getElementById("commentText");
    const commentSubmitButton = document.getElementById("commentSubmitButton");
    const commentsContainer = document.getElementById("commentsContainer");
    const tabsContainer = document.getElementById("tabsContainer");
    const loadingElement = document.getElementById("loading");
    const sortControl = document.getElementById("sortControl"); // NEW: Sort element

    // --- Auth Elements ---
    const welcomeScreen = document.getElementById("welcomeScreen");
    const mainApp = document.getElementById("mainApp");
    const loginForm = document.getElementById("loginForm");
    const usernameInput = document.getElementById("usernameInput");
    const passwordInput = document.getElementById("passwordInput");
    const loginButton = document.getElementById("loginButton");
    const registerButton = document.getElementById("registerButton");
    const authError = document.getElementById("authError");
    const authStatus = document.getElementById("authStatus");
    const logoutButton = document.getElementById("logoutButton");
    
    // --- Notification Elements ---
    const notificationBell = document.getElementById("notificationBell");
    const notificationDot = document.getElementById("notificationDot");
    const notificationPanel = document.getElementById("notificationPanel");
    const notificationList = document.getElementById("notificationList");
    
    // --- Modal Elements ---
    const whatsNewModal = document.getElementById("whatsNewModal");
    const closeModalButton = document.getElementById("closeModalButton");

    // =============================
    // Utility Functions (NEW)
    // =============================
    
    /**
     * Calculates total reactions for a comment.
     */
    function getTotalReactions(comment) {
      if (!comment.reactions) return 0;
      return Object.values(comment.reactions).reduce((sum, count) => sum + (count || 0), 0);
    }

    /**
     * Converts a timestamp to relative time string.
     */
    function timeAgo(timestamp) {
      if (!timestamp) return '...';
      const now = Date.now();
      const seconds = Math.floor((now - timestamp) / 1000);

      let interval = seconds / 31536000; // years
      if (interval > 1) return Math.floor(interval) + "y ago";
      interval = seconds / 2592000; // months
      if (interval > 1) return Math.floor(interval) + "mo ago";
      interval = seconds / 86400; // days
      if (interval > 1) return Math.floor(interval) + "d ago";
      interval = seconds / 3600; // hours
      if (interval > 1) return Math.floor(interval) + "h ago";
      interval = seconds / 60; // minutes
      if (interval > 1) return Math.floor(interval) + "m ago";
      if (seconds < 10) return "just now";
      return Math.floor(seconds) + "s ago";
    }

    // =============================
    // "What's New" Modal Logic
    // =============================
    function showModal() {
      whatsNewModal.classList.add("show");
    }
    
    function hideModal() {
      whatsNewModal.classList.remove("show");
    }

    closeModalButton.addEventListener("click", () => {
      localStorage.setItem(WHATS_NEW_KEY, 'true');
      hideModal();
      // Show login screen only if user is not logged in
      if (!currentUserId) {
        welcomeScreen.style.display = "block";
      }
    });

    // =============================
    // Authentication
    // =============================

    // Listen for auth state changes
    onAuthStateChanged(auth, (user) => {
      // First, check if modal should be shown
      const hasSeenModal = localStorage.getItem(WHATS_NEW_KEY);
      if (!hasSeenModal) {
        showModal();
        // Hide login screen while modal is shown
        welcomeScreen.style.display = "none";
      }

      if (user) {
        // User is signed in
        currentUserId = user.uid;
        
        // Fetch username from DB
        const userRef = ref(db, `users/${currentUserId}/username`);
        onValue(userRef, (snapshot) => {
          currentUsername = snapshot.val();
          authStatus.textContent = `Logged in as: ${currentUsername || 'Guest'}`;
          
          // Enable forms and load data
          commentText.disabled = false;
          commentSubmitButton.disabled = false;
          welcomeScreen.style.display = "none";
          mainApp.style.display = "block";
          
          loadComments();
          setupNotificationListener();

        }, { onlyOnce: true }); // Only need this once on login

      } else {
        // User is signed out
        currentUserId = null;
        currentUsername = null;
        
        // Disable forms and show login screen
        authStatus.textContent = "Not logged in.";
        commentText.disabled = true;
        commentSubmitButton.disabled = true;
        mainApp.style.display = "none";
        
        // Only show login screen if modal is *not* active
        if (hasSeenModal) {
          welcomeScreen.style.display = "block";
        }
        
        // Clean up listeners
        if (currentCommentsRef) off(currentCommentsRef);
        if (notificationListener) off(notificationListener);
        commentsContainer.innerHTML = '<p class="empty-message">Please log in to see comments.</p>';
        notificationList.innerHTML = '<div class="notification-item-empty">Please log in.</div>';
        notificationDot.style.display = "none";
      }
    });

    // Handle Login
    loginButton.addEventListener("click", (e) => {
      e.preventDefault();
      authError.textContent = "";
      const username = usernameInput.value.trim();
      const password = passwordInput.value;
      const email = `${username.toLowerCase()}@isrt-feedback.com`;
      
      signInWithEmailAndPassword(auth, email, password)
        .catch((error) => {
          console.error("Login failed:", error);
          if (error.code === 'auth/invalid-credential') {
             authError.textContent = "Invalid username or password.";
          } else {
             authError.textContent = "Login failed. Please try again.";
          }
        });
    });

    // Handle Register
    registerButton.addEventListener("click", (e) => {
      e.preventDefault();
      authError.textContent = "";
      const username = usernameInput.value.trim();
      const password = passwordInput.value;
      
      if (username.length < 3) {
        authError.textContent = "Username must be at least 3 characters.";
        return;
      }
      if (password.length < 6) {
        authError.textContent = "Password must be at least 6 characters.";
        return;
      }
      
      const email = `${username.toLowerCase()}@isrt-feedback.com`;

      createUserWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          // Now, save the username to the database
          const userRef = ref(db, `users/${userCredential.user.uid}`);
          set(userRef, {
            username: username
          });
          // Auth state change will handle the rest
        })
        .catch((error) => {
          console.error("Registration failed:", error);
          if (error.code === 'auth/email-already-in-use') {
            authError.textContent = "This username is already taken.";
          } else {
            authError.textContent = "Registration failed. Please try again.";
          }
        });
    });

    // Handle Logout
    logoutButton.addEventListener("click", () => {
      signOut(auth);
    });

    // =============================
    // Notification System
    // =============================
    
    notificationBell.addEventListener("click", () => {
      const isPanelOpen = notificationPanel.style.display === 'block';
      notificationPanel.style.display = isPanelOpen ? 'none' : 'block';
      
      // If opening, mark notifications as read
      if (!isPanelOpen) {
        notificationDot.style.display = 'none';
        markNotificationsAsRead();
      }
    });
    
    // Close panel if clicking outside
    document.addEventListener('click', (e) => {
      if (!notificationBell.contains(e.target) && !notificationPanel.contains(e.target)) {
        notificationPanel.style.display = 'none';
      }
    });
    
    function setupNotificationListener() {
      if (notificationListener) off(notificationListener);
      
      const notificationsRef = query(ref(db, `notifications/${currentUserId}`), orderByChild('timestamp'));
      notificationListener = onValue(notificationsRef, (snapshot) => {
        notificationList.innerHTML = '';
        const data = snapshot.val();
        let hasUnread = false;
        
        if (!data) {
          notificationList.innerHTML = '<div class="notification-item-empty">No notifications yet.</div>';
          notificationDot.style.display = 'none';
          return;
        }
        
        const notifications = Object.entries(data)
          .map(([id, n]) => ({ id, ...n }))
          .sort((a, b) => b.timestamp - a.timestamp); // Sort by newest first
          
        notifications.forEach(n => {
          const el = document.createElement('div');
          el.classList.add('notification-item');
          if (n.unread) {
            el.classList.add('unread');
            hasUnread = true;
          }
          el.textContent = n.text;
          notificationList.appendChild(el);
        });
        
        notificationDot.style.display = hasUnread ? 'block' : 'none';
      });
    }
    
    function markNotificationsAsRead() {
      const notificationsRef = ref(db, `notifications/${currentUserId}`);
      onValue(notificationsRef, (snapshot) => {
        const updates = {};
        snapshot.forEach((child) => {
          if (child.val().unread) {
            updates[`${child.key}/unread`] = false;
          }
        });
        if (Object.keys(updates).length > 0) {
          update(ref(db, `notifications/${currentUserId}`), updates);
        }
      }, { onlyOnce: true }); // Only need to do this once
    }
    
    async function sendNotification(targetUserId, text) {
      if (targetUserId === currentUserId) return; // Don't notify self
      
      const notification = {
        text: text,
        timestamp: serverTimestamp(),
        unread: true
      };
      
      const newNotificationRef = push(ref(db, `notifications/${targetUserId}`));
      await set(newNotificationRef, notification);
    }

    // =============================
    // Main App Logic (Tabs & Comments)
    // =============================

    // Handle Tab Switching
    tabsContainer.addEventListener("click", (e) => {
      if (e.target.classList.contains("tab-btn")) {
        const newCategory = e.target.dataset.category;
        if (newCategory === currentCategory) return;
        
        tabsContainer.querySelector(".active").classList.remove("active");
        e.target.classList.add("active");
        currentCategory = newCategory;
        
        // Hide form on "All Comments" tab
        commentForm.style.display = (currentCategory === 'all') ? 'none' : 'block';
        
        loadComments();
      }
    });

    // NEW: Handle Sort Switching
    sortControl.addEventListener('change', (e) => {
      currentSort = e.target.value;
      loadComments();
    });

    // Handle Comment Submission
    commentForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const text = commentText.value.trim();
      if (!text || !currentUserId || !currentUsername) return;

      const comment = {
        text,
        timestamp: serverTimestamp(),
        category: currentCategory,
        userId: currentUserId,
        username: currentUsername,
        replies: {},
        reactions: {},
      };

      const commentsRef = ref(db, `comments/${currentCategory}`);
      push(commentsRef, comment);
      commentText.value = "";
    });
    
    // Load Comments for Current Category
    function loadComments() {
      commentsContainer.innerHTML = "";
      loadingElement.style.display = "block";
      
      // Detach old listener *if* it exists
      if (currentCommentsRef) {
        off(currentCommentsRef);
        currentCommentsRef = null;
      }

      if (currentCategory === 'all') {
        loadAllComments();
      } else {
        loadCategoryComments(currentCategory);
      }
    }

    function loadCategoryComments(category) {
      // Use query... but sorting by timestamp in FB is only for filtering,
      // we must sort manually after fetch for custom logic.
      currentCommentsRef = ref(db, `comments/${category}`);
      onValue(currentCommentsRef, (snapshot) => {
        loadingElement.style.display = "none";
        commentsContainer.innerHTML = "";
        const data = snapshot.val();
        
        if (!data) {
          commentsContainer.innerHTML = '<p class="empty-message">No comments yet. Be the first!</p>';
          return;
        }
        
        let comments = Object.entries(data)
          .map(([id, c]) => ({ id, ...c, isOld: false, category: category }));
        
        // --- NEW: Sorting Logic ---
        if (currentSort === 'mostReacted') {
          comments.sort((a, b) => getTotalReactions(b) - getTotalReactions(a));
        } else {
          comments.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); // Default
        }
          
        comments.forEach((c) => {
          const el = createCommentElement(c);
          commentsContainer.appendChild(el);
        });
      });
    }

    function loadAllComments() {
      // This is more complex. We fetch all categories + root comments.
      const allCommentsRef = ref(db, `comments`);
      // We use onlyOnce: true for performance on "All" tab.
      // It will re-sort if the sort dropdown is changed.
      onValue(allCommentsRef, (snapshot) => {
        loadingElement.style.display = "none";
        commentsContainer.innerHTML = "";
        const allData = snapshot.val();
        let allComments = [];

        if (!allData) {
          commentsContainer.innerHTML = '<p class="empty-message">No comments found anywhere.</p>';
          return;
        }

        Object.entries(allData).forEach(([key, value]) => {
          if (['seniors', 'juniors', 'faculty', 'general'].includes(key)) {
            // This is a category folder
            Object.entries(value).forEach(([id, c]) => {
              allComments.push({ id, ...c, isOld: false, category: key });
            });
          } else if (value && typeof value === 'object' && value.timestamp) {
            // This is an "old" root-level comment
            allComments.push({ id: key, ...value, isOld: true, category: 'general' });
          }
        });

        // --- NEW: Sorting Logic ---
        if (currentSort === 'mostReacted') {
          allComments.sort((a, b) => getTotalReactions(b) - getTotalReactions(a));
        } else {
          allComments.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); // Default
        }
        
        if (allComments.length === 0) {
          commentsContainer.innerHTML = '<p class="empty-message">No comments found anywhere.</p>';
          return;
        }
        
        allComments.forEach((c) => {
          const el = createCommentElement(c);
          commentsContainer.appendChild(el);
        });
        
      }, { onlyOnce: true });
    }

    // =============================
    // Create Comment/Reply Element
    // =============================
    function createCommentElement(comment, isReply = false, parentComment = null) {
      const box = document.createElement("div");
      box.classList.add(isReply ? "reply-box" : "comment-box");

      // --- Author Line (Author + Timestamp) ---
      const authorLine = document.createElement("div");
      authorLine.classList.add("author-line");

      const author = document.createElement("span");
      author.classList.add("comment-author");
      author.textContent = comment.username || 'Anonymous';
      if (comment.username) {
        const lowerCaseUsername = comment.username.toLowerCase();
        if (lowerCaseUsername === 'admin') {
          author.classList.add("admin");
        } else if (lowerCaseUsername === 'tuntun') {
          author.classList.add("tuntun");
        }
      }
      authorLine.appendChild(author);
      
      // NEW: Timestamp
      const timestamp = document.createElement("span");
      timestamp.classList.add("comment-timestamp");
      timestamp.textContent = `‚Ä¢ ${timeAgo(comment.timestamp)}`;
      authorLine.appendChild(timestamp);
      
      box.appendChild(authorLine);


      // --- Comment Text ---
      const text = document.createElement("p");
      text.textContent = comment.text;
      text.style.display = "block"; // Default state
      box.appendChild(text);

      // --- Edit Form (Hidden) ---
      let editForm = null;
      if (comment.userId === currentUserId) {
        editForm = document.createElement("form");
        editForm.classList.add("edit-form");
        editForm.style.display = "none";
        
        const editInput = document.createElement("textarea");
        editInput.value = comment.text;
        
        const saveButton = document.createElement("button");
        saveButton.type = "submit";
        saveButton.textContent = "Save";
        
        const cancelButton = document.createElement("button");
        cancelButton.type = "button";
        cancelButton.textContent = "Cancel";
        cancelButton.classList.add("cancel-btn");
        
        editForm.appendChild(editInput);
        editForm.appendChild(saveButton);
        editForm.appendChild(cancelButton);
        box.appendChild(editForm);

        // Edit form submit logic
        editForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const newText = editInput.value.trim();
          if (!newText) return;

          let path;
          if (isReply) {
            // Path for a reply
            const cat = parentComment.isOld ? '' : `/${parentComment.category}`;
            path = `comments${cat}/${parentComment.id}/replies/${comment.id}/text`;
          } else {
            // Path for a comment
            const cat = comment.isOld ? '' : `/${comment.category}`;
            path = `comments${cat}/${comment.id}/text`;
          }
          
          update(ref(db), { [path]: newText });
          text.textContent = newText;
          text.style.display = "block";
          editForm.style.display = "none";
        });
        
        // Cancel button logic
        cancelButton.addEventListener("click", () => {
          text.style.display = "block";
          editForm.style.display = "none";
        });
      }

      // --- Controls (Reply, Edit, Delete) ---
      const controls = document.createElement("div");
      controls.classList.add("controls");
      
      // Reply Button
      if (!isReply && currentCategory !== 'all') {
        const replyBtn = document.createElement("button");
        replyBtn.textContent = "üí¨ Reply";
        replyBtn.classList.add("reply-btn");
        controls.appendChild(replyBtn);
        
        replyBtn.addEventListener("click", (e) => {
          e.preventDefault();
          // Stop if click was on a reaction
          if (e.target.classList.contains("reaction")) return;
          e.stopPropagation();
          
          const isOpen = replyForm.style.display === "block";
          // Close all *other* reply forms
          document.querySelectorAll('.reply-form').forEach(f => f.style.display = 'none');
          if (!isOpen) {
            replyForm.style.display = "block";
            replyForm.querySelector('textarea').focus();
          }
        });
      }
      
      // NEW: Check for admin status
      const isAdmin = currentUsername && currentUsername.toLowerCase() === 'admin';
      
      // Edit Button (Owner only)
      if (comment.userId === currentUserId) {
        const editBtn = document.createElement("button");
        editBtn.textContent = "‚úèÔ∏è";
        editBtn.title = "Edit";
        editBtn.classList.add("edit-btn");
        controls.appendChild(editBtn);
        
        editBtn.addEventListener("click", () => {
          text.style.display = "none";
          editForm.style.display = "block";
          editForm.querySelector('textarea').focus();
        });
      }
      
      // Delete Button (Owner OR Admin)
      if (comment.userId === currentUserId || isAdmin) {
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "üóëÔ∏è";
        deleteBtn.title = "Delete";
        deleteBtn.classList.add("delete-btn");
        controls.appendChild(deleteBtn);
        
        deleteBtn.addEventListener("click", () => {
          if (deleteBtn.classList.contains("confirm")) {
            // --- Confirmed Delete ---
            let path;
            if (isReply) {
              const cat = parentComment.isOld ? '' : `/${parentComment.category}`;
              path = `comments${cat}/${parentComment.id}/replies/${comment.id}`;
            } else {
              const cat = comment.isOld ? '' : `/${comment.category}`;
              path = `comments${cat}/${comment.id}`;
            }
            remove(ref(db, path));
            // The onValue listener will handle removing the element
            
          } else {
            // --- Ask for confirmation ---
            deleteBtn.classList.add("confirm");
            deleteBtn.textContent = "Confirm?";
            setTimeout(() => {
              deleteBtn.classList.remove("confirm");
              deleteBtn.textContent = "üóëÔ∏è";
            }, 3000); // Reset after 3 seconds
          }
        });
      }
      
      box.appendChild(controls);

      // --- Reaction Buttons ---
      const reactionContainer = document.createElement("div");
      reactionContainer.classList.add("reaction-options");
      
      reactions.forEach((emoji) => {
        const span = document.createElement("span");
        const count = comment.reactions?.[emoji] || 0;
        span.textContent = count > 0 ? `${emoji} ${count}` : emoji;
        span.classList.add("reaction");

        span.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopImmediatePropagation();
          e.stopPropagation();
          
          let basePath;
          if (isReply) {
            const cat = parentComment.isOld ? '' : `/${parentComment.category}`;
            basePath = `comments${cat}/${parentComment.id}/replies/${comment.id}`;
          } else {
            const cat = comment.isOld ? '' : `/${comment.category}`;
            basePath = `comments${cat}/${comment.id}`;
          }
          
          const path = `${basePath}/reactions/${emoji}`;
          const newCount = (comment.reactions?.[emoji] || 0) + 1;
          update(ref(db), { [path]: newCount });
          
          // Send notification
          sendNotification(comment.userId, `${currentUsername} reacted ${emoji} to your ${isReply ? 'reply' : 'comment'}.`);
        });

        reactionContainer.appendChild(span);
      });
      controls.appendChild(reactionContainer); // Add to controls

      // --- Reply Form (Hidden) ---
      let replyForm = null;
      if (!isReply) {
        replyForm = document.createElement("form");
        replyForm.classList.add("reply-form");
        replyForm.style.display = "none";

        const replyInput = document.createElement("textarea");
        replyInput.placeholder = "Write a reply...";
        const replySubmit = document.createElement("button");
        replySubmit.type = "submit";
        replySubmit.textContent = "Post Reply";

        replyForm.appendChild(replyInput);
        replyForm.appendChild(replySubmit);
        box.appendChild(replyForm);

        replyForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const replyText = replyInput.value.trim();
          if (!replyText || !currentUserId || !currentUsername) return;

          const reply = {
            text: replyText,
            timestamp: serverTimestamp(),
            userId: currentUserId,
            username: currentUsername,
            reactions: {},
          };

          const cat = comment.isOld ? '' : `/${comment.category}`;
          const repliesRef = ref(db, `comments${cat}/${comment.id}/replies`);
          push(repliesRef, reply);
          
          // Send notification
          sendNotification(comment.userId, `${currentUsername} replied to your comment.`);

          replyInput.value = "";
          replyForm.style.display = "none";
        });
      }

      // --- Render Replies Recursively ---
      if (comment.replies) {
        const repliesDiv = document.createElement("div");
        repliesDiv.classList.add("replies");
        const sorted = Object.entries(comment.replies)
          .map(([id, r]) => ({ id, ...r }))
          .sort((a, b) => a.timestamp - b.timestamp);
          
        sorted.forEach((r) => {
          // Pass the original comment (which is the parent)
          repliesDiv.appendChild(createCommentElement(r, true, comment));
        });
        box.appendChild(repliesDiv);
      }

      return box;
    }

    // Initial check (in case user is already logged in)
    // onAuthStateChanged will handle the initial load
  </script>
</body>
</html>
