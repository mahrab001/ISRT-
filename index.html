<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Anonymous ISRT Feedback ‚úçÔ∏è</title>
  
  <style>
    /* ====== General Page Styling ====== */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Inter",
        "Helvetica Neue", Arial, sans-serif;
      background-color: #121212;
      color: #e0e0e0;
      line-height: 1.6;
      padding: 20px;
      margin: 0;
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
      background-color: #1e1e1e;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    }

    h1 {
      text-align: center;
      color: #58a6ff;
      margin-top: 0;
    }

    p {
      color: #b0b0b0;
    }

    hr {
      border: 0;
      border-top: 1px solid #333;
      margin: 20px 0;
    }

    /* ====== Tabs Styling ====== */
    .tabs-container {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #333;
      flex-wrap: wrap; /* Allow tabs to wrap on small screens */
    }

    .tab-btn {
      padding: 10px 15px;
      cursor: pointer;
      background-color: transparent;
      border: none;
      color: #aaa;
      font-size: 16px;
      font-weight: 600;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
      border-radius: 4px 4px 0 0;
    }

    .tab-btn:hover {
      color: #e0e0e0;
      background-color: #2a2a2a;
    }

    .tab-btn.active {
      color: #58a6ff;
      border-bottom-color: #58a6ff;
    }

    /* ====== Comment Form ====== */
    #commentForm textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 12px;
      border: 1px solid #444;
      border-radius: 8px;
      resize: vertical;
      min-height: 80px;
      margin-bottom: 10px;
      background-color: #222;
      color: #e0e0e0;
      font-size: 15px;
    }

    #commentForm textarea:focus {
      outline: none;
      border-color: #58a6ff;
      box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2);
    }

    #commentForm button {
      width: 100%;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.1s ease;
    }

    #commentForm button:hover {
      background-color: #0056b3;
    }

    #commentForm button:active {
      transform: scale(0.98);
    }

    /* ====== Comments & Replies ====== */
    .comment-box,
    .reply-box {
      position: relative;
      border: 1px solid #333;
      padding: 12px 15px 45px 15px; /* Increased bottom padding for controls */
      border-radius: 8px;
      margin-top: 12px;
      background-color: #252525;
    }

    .reply-box {
      margin-left: 30px; /* Slightly reduced indent */
      background-color: #282828;
      border-color: #444;
    }

    .comment-box p,
    .reply-box p {
      margin: 0 0 8px 0;
      font-size: 15px;
      color: #f5f5f5;
      white-space: pre-wrap; /* Keeps line breaks */
      word-break: break-word;
    }

    /* ====== Reaction and Reply Controls ====== */
    .controls {
      position: absolute;
      bottom: 8px;
      left: 15px;
      right: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
    }

    .reaction-options {
      display: flex;
      gap: 6px;
      /* Ensure reactions are on the right */
      margin-left: auto; 
    }

    .reaction {
      cursor: pointer;
      font-size: 14px; /* Slightly smaller for a cleaner look */
      transition: transform 0.2s, filter 0.2s;
      user-select: none;
      padding: 4px 6px;
      border-radius: 10px;
      background-color: #333;
    }

    .reaction:hover {
      transform: scale(1.2);
      background-color: #444;
    }

    .reaction.reacted {
      /* Placeholder for a "reacted" state */
      background-color: #007bff;
      color: #fff;
    }

    .reply-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: #58a6ff;
      transition: color 0.3s;
      padding: 4px 0;
      /* Ensure reply button is on the left */
      margin-right: auto;
    }

    .reply-btn:hover {
      color: #1e90ff;
    }

    .replies {
      margin-top: 10px;
      /* margin-left: 20px; Handled by reply-box margin */
    }

    /* ====== Reply Form ====== */
    .reply-form {
      margin-top: 15px;
      background-color: #202020;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 10px;
    }

    .reply-form textarea {
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #555;
      border-radius: 4px;
      resize: vertical;
      min-height: 60px;
      padding: 6px;
      background-color: #2a2a2a;
      color: #e0e0e0;
    }

    .reply-form textarea:focus {
      outline: none;
      border-color: #58a6ff;
    }

    .reply-form button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 6px 12px;
      margin-top: 6px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s ease;
    }

    .reply-form button:hover {
      background-color: #0056b3;
    }

    /* ====== Loading/Empty State ====== */
    #commentsContainer .empty-state,
    #loading {
      text-align: center;
      color: #bbb;
      font-style: italic;
      margin-top: 30px;
      padding: 20px;
      background-color: #222;
      border-radius: 8px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Anonymous ISRT Feedback ‚úçÔ∏è</h1>
    <p>Write a comment about ISRT without sharing any personal details. All comments are anonymous.</p>

    <p style="text-align: center; font-size: 1.1em; color: #c0c0c0; margin-bottom: 10px;">Share your thoughts about</p>

    <div id="tabsContainer" class="tabs-container">
      <button class="tab-btn active" data-category="general">General</button>
      <button class="tab-btn" data-category="seniors">Seniors</button>
      <button class="tab-btn" data-category="juniors">Juniors</button>
      <button class="tab-btn" data-category="faculty">Faculty</button>
      <button class="tab-btn" data-category="all">All Comments</button>
    </div>

    <form id="commentForm">
      <textarea id="commentText" placeholder="Your anonymous comment here..." required></textarea>
      <button type="submit" id="submitButton">Submit Anonymous Comment</button>
    </form>

    <hr />
    <p style="text-align: center; font-size: 0.9em; color: #aaa; margin-top: -10px; margin-bottom: 20px;"><i>Previous Comments are stored in all comments section.</i></p>
    <h2>Previous Comments</h2>
    <div id="loading" style="text-align: center; margin: 20px 0;">Loading comments...</div>
    <div id="commentsContainer"><p class="empty-state">No comments yet. Be the first!</p></div>
  </div>

  <script type="module">
    // --- Import Firebase RTDB Services ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      onValue,
      update,
      off,
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    // --- Firebase Configuration (from script.js) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBi0DtNzX0niHbV4LtId7PaxLoD8Pphy6U",
      authDomain: "comment-on-isrt-8a634.firebaseapp.com",
      databaseURL: "https://comment-on-isrt-8a634-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "comment-on-isrt-8a634",
      storageBucket: "comment-on-isrt-8a634.appspot.com",
      messagingSenderId: "173989173917",
      appId: "1:173989173917:web:613693b2c98c4c121e9274",
    };

    // --- Initialize Firebase ---
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- Global State ---
    let currentCategory = 'general';
    let currentCommentsRef = null; // To store the current DB reference
    const reactions = ["üëç", "üòÇ", "üòç", "üò¢", "üòÆ", "üò°", "üòÄ"];

    // --- DOM Elements ---
    const commentForm = document.getElementById("commentForm");
    const commentText = document.getElementById("commentText");
    const submitButton = document.getElementById("submitButton");
    const commentsContainer = document.getElementById("commentsContainer");
    const tabsContainer = document.getElementById("tabsContainer");
    const loadingElement = document.getElementById("loading");

    // --- Event Listeners ---

    /**
     * Handle Tab Switching
     */
    tabsContainer.addEventListener("click", (e) => {
      if (!e.target.classList.contains("tab-btn")) return;

      const newCategory = e.target.dataset.category;
      if (newCategory === currentCategory) return;

      // --- New: Show/Hide comment form based on tab ---
      if (newCategory === 'all') {
        commentForm.style.display = 'none';
      } else {
        commentForm.style.display = 'block';
      }
      // --- End New ---

      tabsContainer.querySelector(".active").classList.remove("active");
      e.target.classList.add("active");
      currentCategory = newCategory;
      
      loadComments();
    });

    /**
     * Handle New Comment Submission
     */
    commentForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const text = commentText.value.trim();
      if (!text) return;

      submitButton.disabled = true;
      submitButton.textContent = "Submitting...";

      const comment = {
        text,
        category: currentCategory, // Store the actual category
        timestamp: Date.now(),
        reactions: {},
        replies: {},
      };

      try {
        // Get a DB ref based on the current category
        // This works because the form is hidden when currentCategory === 'all'
        const commentsRef = ref(db, `comments/${currentCategory}`);
        push(commentsRef, comment);
        commentText.value = "";
      } catch (error) {
        console.error("Error adding comment: ", error);
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = "Submit Anonymous Comment";
      }
    });

    /**
     * Load Comments for the Current Category
     */
    function loadComments() {
      console.log(`Loading comments for: ${currentCategory}`);
      commentsContainer.innerHTML = "";
      loadingElement.style.display = "block";

      // Detach the old listener, if one exists
      if (currentCommentsRef) {
        console.log("Detaching previous listener.");
        off(currentCommentsRef);
        currentCommentsRef = null;
      }

      // --- New: Create ref for 'all' or a specific category ---
      let newRef;
      if (currentCategory === 'all') {
        newRef = ref(db, 'comments'); // Listen to the root 'comments' node
      } else {
        newRef = ref(db, `comments/${currentCategory}`); // Listen to specific category
      }
      currentCommentsRef = newRef;
      // --- End New ---

      // Attach the new real-time listener
      onValue(currentCommentsRef, (snapshot) => {
        loadingElement.style.display = "none";
        const data = snapshot.val();
        
        if (!data) {
          commentsContainer.innerHTML = "<p class='empty-state'>No comments yet. Be the first!</p>";
          return;
        }

        // --- New: Process data for 'all' or a single category ---
        const comments = [];
        if (currentCategory === 'all') {
          // New aggregation logic for 'all' tab
          const allNodes = data; // This is the root 'comments' node
          Object.entries(allNodes).forEach(([key, value]) => {
            if (value && typeof value.text === 'string' && typeof value.timestamp === 'number') {
              // This is a single, top-level (old) comment.
              // We check for 'text' and 'timestamp' to be sure.
              comments.push({ 
                id: key, 
                ...value, 
                category: value.category || 'general', // Default old comments to 'general'
                isRootComment: true // Add flag for old comments
              });
            } else if (value && typeof value === 'object') {
              // This is a category node (e.g., 'seniors', 'juniors')
              const categoryName = key;
              const commentsInCategory = value;
              Object.entries(commentsInCategory).forEach(([commentId, commentData]) => {
                // This is a comment from within a category
                comments.push({ 
                  id: commentId, 
                  ...commentData, 
                  category: categoryName, // The category is the key
                  isRootComment: false // Add flag for new comments
                });
              });
            }
          });
        } else {
          // Standard logic for a single category
          Object.entries(data).forEach(([id, c]) => {
            comments.push({ id, ...c, isRootComment: false }); // Explicitly set root flag
          });
        }
        // --- End New ---
        
        // Sort by timestamp, descending. (Works for all cases)
        comments.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

        // Render comments
        commentsContainer.innerHTML = ""; // Clear for re-render
        comments.forEach((c) => {
          const el = createCommentElement(c, false, null);
          commentsContainer.appendChild(el);
        });

      }, (error) => {
        console.error("Error loading comments: ", error);
        loadingElement.style.display = "none";
        commentsContainer.innerHTML = "<p class='empty-state'>Error loading comments.</p>";
      });
    }

    /**
     * Creates the DOM element for a single comment or reply.
     * @param {object} item - The comment or reply object from RTDB.
     * @param {boolean} isReply - True if this is a reply.
     * @param {string | null} parentId - The ID of the parent comment (if it's a reply).
     * @param {string | null} parentCategory - The category of the parent comment.
     * @param {boolean} parentIsRoot - True if the parent comment is a root-level comment.
     */
    function createCommentElement(item, isReply = false, parentId = null, parentCategory = null, parentIsRoot = false) {
      const box = document.createElement("div");
      box.classList.add(isReply ? "reply-box" : "comment-box");
      box.dataset.id = item.id;

      const text = document.createElement("p");
      text.textContent = item.text;
      box.appendChild(text);

      const controls = document.createElement("div");
      controls.classList.add("controls");

      let replyForm = null;

      // --- Reply Button & Form (for parent comments only) ---
      // --- Updated: Only show reply button if NOT a reply AND NOT in 'all' category ---
      if (!isReply && currentCategory !== 'all') {
        const replyBtn = document.createElement("button");
        replyBtn.textContent = "üí¨ Reply";
        replyBtn.classList.add("reply-btn");
        controls.appendChild(replyBtn);

        replyForm = document.createElement("form");
        replyForm.classList.add("reply-form");
        replyForm.style.display = "none";

        const replyInput = document.createElement("textarea");
        replyInput.placeholder = "Write a reply...";
        const replySubmit = document.createElement("button");
        replySubmit.type = "submit";
        replySubmit.textContent = "Post Reply";

        replyForm.appendChild(replyInput);
        replyForm.appendChild(replySubmit);

        replyBtn.addEventListener("click", (e) => {
          if (e.target.closest('.reaction')) {
            e.preventDefault();
            e.stopImmediatePropagation();
            return;
          }
          e.preventDefault();
          e.stopPropagation();
          document.querySelectorAll('.reply-form').forEach(f => {
              if (f !== replyForm) f.style.display = 'none';
          });
          const isOpen = replyForm.style.display === "block";
          replyForm.style.display = isOpen ? "none" : "block";
          if (!isOpen) {
            replyInput.focus();
          }
        });

        replyForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const replyText = replyInput.value.trim();
          if (!replyText) return;

          replySubmit.disabled = true;
          
          const reply = {
            text: replyText,
            timestamp: Date.now(),
            reactions: {},
          };

          try {
            // --- Updated: Use item.category and isRootComment to post reply to correct path ---
            let repliesRef;
            if (item.isRootComment) {
              repliesRef = ref(db, `comments/${item.id}/replies`);
            } else {
              repliesRef = ref(db, `comments/${item.category}/${item.id}/replies`);
            }
            push(repliesRef, reply);
            replyInput.value = "";
            replyForm.style.display = "none";
          } catch (error) {
            console.error("Error adding reply: ", error);
          } finally {
            replySubmit.disabled = false;
          }
        });
      }

      // --- Reaction Buttons (for all items) ---
      const reactionContainer = document.createElement("div");
      reactionContainer.classList.add("reaction-options");

      reactions.forEach((emoji) => {
        const span = document.createElement("span");
        const count = item.reactions?.[emoji] || 0;
        span.textContent = count > 0 ? `${emoji} ${count}` : emoji;
        span.classList.add("reaction");

        span.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopImmediatePropagation();
          
          // --- Updated: Determine correct category for reaction path ---
          let path;
          // If it's a reply, use parentCategory. If it's a parent, use item.category.
          const itemCategory = parentCategory || item.category;
          const isRoot = parentIsRoot || item.isRootComment; // Check if item or parent is root

          if (!itemCategory) {
            console.error("Missing category for reaction!", item);
            return; // Safety check
          }
          
          if (isReply) {
            // Path for a reply's reaction
            if (isRoot) {
              path = `comments/${parentId}/replies/${item.id}/reactions/${emoji}`;
            } else {
              path = `comments/${itemCategory}/${parentId}/replies/${item.id}/reactions/${emoji}`;
            }
          } else {
            // Path for a parent comment's reaction
            if (isRoot) {
              path = `comments/${item.id}/reactions/${emoji}`;
            } else {
              path = `comments/${itemCategory}/${item.id}/reactions/${emoji}`;
            }
          }
          // --- End Update ---

          const newCount = (item.reactions?.[emoji] || 0) + 1;
          
          try {
            update(ref(db), { [path]: newCount });
            // The onValue listener will update this, but for instant
            // feedback, we can update the text content locally.
            span.textContent = `${emoji} ${newCount}`;
          } catch (error) {
            console.error("Error updating reaction: ", error);
          }
        });

        reactionContainer.appendChild(span);
      });
      
      controls.appendChild(reactionContainer);
      box.appendChild(controls);
      if (replyForm) box.appendChild(replyForm);

      // --- Render Replies (for parent comments only) ---
      // This works because the main onValue listener gets the entire object
      // including the 'replies' node.
      if (!isReply && item.replies) {
        const repliesDiv = document.createElement("div");
        repliesDiv.classList.add("replies");
        box.appendChild(repliesDiv);

        // Sort replies by timestamp, ascending
        const replies = Object.entries(item.replies)
          .map(([id, r]) => ({ id, ...r }))
          .sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));

        replies.forEach((r) => {
          // --- Updated: Pass parent's category and root flag to recursive call ---
          repliesDiv.appendChild(createCommentElement(r, true, item.id, item.category, item.isRootComment));
        });
      }

      return box;
    }

    // Initial load
    loadComments();
  </script>
</body>
</html>

